<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rednote.mapper.CommentMapper">

    <select id="selectTopReplies" resultType="com.rednote.entity.Comment">
        SELECT * FROM (
            SELECT
                t.*,
                ROW_NUMBER() OVER (
                    PARTITION BY t.root_parent_id
                    ORDER BY
                        t.created_at ASC,
                        t.id ASC
                ) as rn
            FROM
                comments t
            WHERE
                t.root_parent_id IN
                <foreach collection="rootIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
        ) tmp
        WHERE rn = 1
    </select>

    <select id="selectReplyCounts" resultType="java.util.Map">
        SELECT root_parent_id as rootId, COUNT(*) as count
        FROM comments
        WHERE root_parent_id IN
        <foreach collection="rootIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        GROUP BY root_parent_id
    </select>

    <select id="selectCommentFeed" resultType="com.rednote.entity.vo.CommentVO">
        SELECT
            c.id,
            c.post_id,
            c.user_id,
            c.content,
            c.like_count,
            c.created_at,
            c.image_url,
            c.image_width,
            c.image_height,
            u.nickname,
            u.avatar_url,
            (CASE WHEN cl.id IS NOT NULL THEN 1 ELSE 0 END) as is_liked
        FROM
            comments c
        LEFT JOIN
            users u ON c.user_id = u.id
        LEFT JOIN
            comment_likes cl ON c.id = cl.comment_id AND cl.user_id = #{currentUserId}
        WHERE
            c.post_id = #{postId}
            AND c.root_parent_id IS NULL
            <if test="lastLikeCount != null and lastId != null">
                AND (
                    c.like_count &lt; #{lastLikeCount}
                    OR (c.like_count = #{lastLikeCount} AND c.id &lt; #{lastId})
                )
            </if>
        ORDER BY
            c.like_count DESC,
            c.id DESC
        LIMIT #{limit}
    </select>

</mapper>
